---
title: 自动检测更新
date: 2024-01-27
tags:
 - interview
categories:
 - interview
---

### 轮询检测js文件
```javascript
const TIME = 60; // 秒

const getHtml = async () => {
  return await fetch("/").then((res) => res.text()); //读取index html
};

const parserScript = (html) => {
  const reg = new RegExp(/<script(?:\s+[^>]*)?>(.*?)<\/script\s*>/gi);
  return html.match(reg); //匹配script标签
};

let flag = true;
const compare = (oldArr, newArr) => {
  const base = oldArr.length;
  const arr = Array.from(new Set(oldArr.concat(newArr)));
  //如果新旧length 不一样 触发更新通知
  if (arr.length != base && flag) {
    flag = false;
    // 提示逻辑
    if (confirm("版本更新了，请刷新页面！！")) {
      location.reload();
    }
  }
};

let oldScript = null;
const init = async () => {
  const html = await getHtml();
  oldScript = parserScript(html);
};

init();

setInterval(async () => {
  const newHtml = await getHtml();
  const newScript = parserScript(newHtml);
  compare(oldScript, newScript);
}, TIME * 1000);
```

### 轮询检测版本号
```javascript
// 推荐
const TIME = 60; // 秒
const PATH = "/version.json"; // 版本信息的路径

const getVersion = async () => {
  try {
    const result = await fetch(PATH);
    if (result.status !== 200) {
      return null;
    }
    const { version } = await result.json();
    return version;
  } catch (error) {
    return null;
  }
};

const isSameVersion = (oldVer, newVer) => oldVer === newVer;

const checkVersion = async (oldVersion) => {
  let newVersion = await getVersion();
  if (!newVersion) {
    return oldVersion;
  }
  console.log({oldVersion, newVersion});
  if (isSameVersion(oldVersion, newVersion)) {
    return oldVersion;
  }

  // 提示逻辑
  if (confirm("版本更新了，请刷新页面！！")) {
    location.reload();
  }

  return newVersion;
};

let oldVersion = "";
const init = async () => {
  oldVersion = await getVersion();
  setInterval(async () => {
    oldVersion = await checkVersion(oldVersion);
  }, TIME * 1000);
};

init();

/**
 * vue.config.js配置
 */
import fs from "fs";
import path from "path";
import crypto from "crypto";
plugins: [
  {
    apply: (compiler) => {
      compiler.hooks.done.tap('VersionPlugin', (stats) => {
        const data = crypto.randomBytes(16).toString('hex')
        const version = crypto.createHash('sha256').update(data).digest('hex')
        const versionContent = JSON.stringify({ version }, null, 2)
        fs.writeFileSync(path.join(__dirname, 'dist', 'version.json'), versionContent)
      })
    }
  }
]

/**
 * vite.config.js
 */
import fs from "fs";
import path from "path";
import crypto from "crypto";

// Vite自定义插件
const createVersionFilePlugin = () => {
  return {
    name: "vite-plugin-version-file",
    generateBundle() {
      const data = crypto.randomBytes(16).toString("hex");
      const version = crypto.createHash("sha256").update(data).digest("hex");
      // const version = Date.now().toString(); // 也可以使用时间戳
      const content = JSON.stringify({ version }, null, 2);
      const outputPath = path.resolve(__dirname, "dist", "version.json");
      fs.writeFileSync(outputPath, content);
    },
  };
};

plugins: [createVersionFilePlugin()]
```
