---
title: 并发请求
date: 2024-03-27
tags:
 - interview
categories:
 - interview
---
## JavaScript并发控制请求

### 使用循环和递归
```javascript
class ConcurrentRequests {
  constructor(urls, maxRequest = 3) {
    this.urls = urls;
    this.maxRequest = maxRequest;
    this.count = 0; // 执行完的数量
    this.concurrentIndex = 0;
    this.index = 0; // 当前下标
    this.results = []; // results
  }

  run() {
    return new Promise((resolve) => {
      if (this.urls.length <= 0) {
        resolve([]);
        return;
      }

      let request = async () => {
        if (this.urls.length <= 0) return resolve([]);
        this.concurrentIndex = this.index;
        let url = this.urls[this.index++];
        try {
          this.results[this.concurrentIndex] = await fetch(url);
        } catch (e) {
          this.results[this.concurrentIndex] = e;
        } finally {
          this.count++;
          if (this.count >= this.urls.length) {
            resolve(this.results);
            return;
          }
          if (this.index < this.urls.length) {
            request();
          }
        }
      };

      const times = Math.min(this.maxRequest, this.urls.length);
      for (let i = 0; i < times; i++) {
        request();
      }
    });
  }
}
```

### 使用Promise.all和循环
```javascript
class ConcurrentRequests {
  constructor(urls, maxConcurrent = 3) {
    this.urls = urls;
    this.maxConcurrent = maxConcurrent;
    this.results = [];
  }

  chunk() {
    let res = [];
    for (let i = 0; i < this.urls.length; i += this.maxConcurrent) {
      res.push(this.urls.slice(i, i + this.maxConcurrent));
    }
    return res;
  }
  
  async quest() {
    try {
      const chunkedUrls = this.chunk();
      for (const urls of chunkedUrls) {
        const promises = urls.map((url) => fetch(url));
        const results = await Promise.all(promises);
        this.results.push(...results);
      }
    } catch (error) {
      console.log(error);
    }
  }

  async run() {
    try {
      await this.quest();
      return this.results;
    } catch (err) {
      console.error(err);
    }
  }
}
```