---
title: vue双向绑定原理
date: 2022-08-25
tags:
 - vue
categories:
 - vue
---
## Vue2响应式原理
```
通过原生JavaScript中的Object.defineproperty方法来对数据进行劫持。  
数据代理：通过一个对象代理对另一个对象中属性的操作（读/写）
```



#### 简单的例子
```js
<script type="text/javascript" >
		let number = 18
		let person = {
			name:'张三',
			sex:'男',
		}
		Object.defineProperty(person,'age',{
			// value:18,
			// enumerable:true, //控制属性是否可以枚举，默认值是false
			// writable:true, //控制属性是否可以被修改，默认值是false
			// configurable:true //控制属性是否可以被删除，默认值是false
			//当有人读取person的age属性时，get函数(getter)就会被调用，且返回值就是age的值
			get(){
				console.log('有人读取age属性了')
				return number
			},
			//当有人修改person的age属性时，set函数(setter)就会被调用，且会收到修改的具体值
			set(value){
				console.log('有人修改了age属性，且值是',value)
				number = value
			}
		})
		// console.log(Object.keys(person))
		console.log(person)
</script>
```

### Vue中的数据代理
```
Vue中的数据代理：  
  通过vm对象来代理data对象中属性的操作（读/写）  
Vue中数据代理的好处：  
  更加方便的操作data中的数据  
基本原理：  
  通过Object.defineProperty()把data对象中所有属性添加到vm上。  
  为每一个添加到vm上的属性，都指定一个getter/setter。  
  在getter/setter内部去操作（读/写）data中对应的属性。
```

#### Vue中的例子
```js
<body>
	<div id="root">
		<h2>名字：{{name}}</h2>
		<h2>地址：{{address}}</h2>
	</div>
</body>
<script type="text/javascript">
	const vm = new Vue({
		el:'#root',
		data:{
			name:'张三',
			address:'上海'
		}
	})
</script>
```
### 手写数据监测

```js
let data = {
  name:'zhangsan',
  address:'北京'
}

//创建一个监视的实例对象，用于监视data中属性的变化
const obs = new Observer(data)
console.log(obs)

//准备一个vm实例对象
let vm = {}
vm._data = data = obs

function Observer(obj) {
	//汇总对象中所有的属性形成一个数组
  const keys = Object.keys(obj)
  //遍历
  keys.forEach((k)=>{
    Object.defineProperty(this,k,{
      get() {
      	return obj[k]
      },
      set(val) {
        console.log(`${k}被改了`)
        obj[k] = val
      }
    })  
  })
}
```



### Vue监视数据的原理

```

1. vue会监视data中所有层次的数据。

2. 如何监测对象中的数据？
	通过setter实现监视，且要在new Vue时就传入要监测的数据。
		(1).对象中后追加的属性，Vue默认不做响应式处理
		(2).如需给后添加的属性做响应式，请使用如下API：
				Vue.set(target，propertyName/index，value) 或 
				vm.$set(target，propertyName/index，value)
				
3. 如何监测数组中的数据？
	通过包裹数组更新元素的方法实现，本质就是做了两件事：
		(1).调用原生对应的方法对数组进行更新。
		(2).重新解析模板，进而更新页面。
		
4.在Vue修改数组中的某个元素一定要用如下方法：
	1.使用这些API:push()、pop()、shift()、unshift()、splice()、sort()、reverse()
	2.Vue.set() 或 vm.$set()
				
特别注意：Vue.set() 和 vm.$set() 不能给vm 或 vm的根数据对象 添加属性！！！
```

### Vue3响应式原理

```js
实现原理: 
  通过Proxy（代理）:  拦截对象中任意属性的变化, 包括：属性值的读写、属性的添加、属性的删除等。
  通过Reflect（反射）:  对源对象的属性进行操作。
  
  new Proxy(data, {
	// 拦截读取属性值
    get (target, prop) {
    	return Reflect.get(target, prop)
    },
    // 拦截设置属性值或添加新属性
    set (target, prop, value) {
    	return Reflect.set(target, prop, value)
    },
    // 拦截删除属性
    deleteProperty (target, prop) {
    	return Reflect.deleteProperty(target, prop)
    }
})

proxy.name = 'tom'   
```

#### MDN文档中描述的Proxy与Reflect

| Proxy   | [https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy) |
| ------- | ------------------------------------------------------------ |
| Reflect | [https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Reflect](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Reflect) |

